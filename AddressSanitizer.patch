From b213f2718334ab66d6f65a1b2547e48d368fa430 Mon Sep 17 00:00:00 2001
From: "xunshan.lsb" <xunshan.lsb@alibaba-inc.com>
Date: Mon, 10 Dec 2018 15:25:20 +0800
Subject: [PATCH] feat: support asan

---
 AliyunNative/build.gradle                | 4 ++--
 AliyunNative/src/main/cpp/CMakeLists.txt | 4 ++++
 2 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/AliyunNative/build.gradle b/AliyunNative/build.gradle
index 928d927da..3a9966586 100755
--- a/AliyunNative/build.gradle
+++ b/AliyunNative/build.gradle
@@ -28,7 +28,7 @@ android {
                 String NATIVE_SHARED_LIB_PATH = project.rootDir.absolutePath + "/Demo/src/main/libs"
                 cmake {
                     arguments '-DANDROID_PLATFORM=android-18',
-                            '-DANDROID_TOOLCHAIN=gcc', '-DANDROID_STL=gnustl_static',
+                            '-DANDROID_TOOLCHAIN=clang', '-DANDROID_STL=gnustl_static',
                             '-D_build_target=QuCore-' + suff, '-D_build_code=3', '-D_ffmpeg_encoder_support=Open',
                             '-D_hardware_encoder_support=Open', '-D_native_crash_handler_support=Close',
                             '-D_leaktracer_support=Close', '-DCMAKE_BUILD_TYPE=Release', '-DCMAKE_LIBRARY_OUTPUT_DIRECTORY=' + NATIVE_SHARED_LIB_PATH
@@ -58,7 +58,7 @@ android {
                 String NATIVE_SHARED_LIB_PATH = project.rootDir.absolutePath + "/Demo/src/main/libs"
                 cmake {
                     arguments '-DANDROID_PLATFORM=android-18',
-                            '-DANDROID_TOOLCHAIN=gcc', '-DANDROID_STL=gnustl_static',
+                            '-DANDROID_TOOLCHAIN=clang', '-DANDROID_STL=gnustl_static',
                             '-D_build_target=QuCore-' + suff, '-D_build_code=3', '-D_ffmpeg_encoder_support=Open',
                             '-D_hardware_encoder_support=Open', '-D_native_crash_handler_support=Close',
                             '-D_leaktracer_support=Close', '-DCMAKE_BUILD_TYPE=Debug', '-DCMAKE_LIBRARY_OUTPUT_DIRECTORY=' + NATIVE_SHARED_LIB_PATH
diff --git a/AliyunNative/src/main/cpp/CMakeLists.txt b/AliyunNative/src/main/cpp/CMakeLists.txt
index 730a050ad..2f660cece 100644
--- a/AliyunNative/src/main/cpp/CMakeLists.txt
+++ b/AliyunNative/src/main/cpp/CMakeLists.txt
@@ -3,6 +3,10 @@ cmake_minimum_required(VERSION 3.6)
 set(NATIVE_PATH ${PROJECT_SOURCE_DIR}/../../../../../native)
 set(NATIVE_SRC_PATH ${NATIVE_PATH}/src)
 set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_LIBRARY_OUTPUT_DIRECTORY}/${ANDROID_ABI})
+set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -g -O0 -fsanitize=address -fno-omit-frame-pointer -Wno-c++11-narrowing ")
+set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -g -O0 -fsanitize=address -fno-omit-frame-pointer ")
+set(CMAKE_SHARED_LINKER_FLAGS "${CMAKE_SHARED_LINKER_FLAGS} -fsanitize=address ")
+set(CMAKE_ANDROID_ARM_MODE ARM)
 
 if ( ${CMAKE_BUILD_TYPE} STREQUAL 'Release' )
     add_definitions(-DAL_LOGD_CLOSE)
-- 
2.19.1

